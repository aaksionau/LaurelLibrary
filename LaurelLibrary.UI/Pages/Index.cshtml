@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

@if (Model.Library != null)
{
    <div class="container d-flex align-items-center justify-content-center" style="min-height: 80vh;">
        <div class="row justify-content-center g-4">
            <div class="col-md-4">
                <a asp-page="/Return" asp-route-libraryId="@Model.LibraryId" asp-route-kioskId="@Model.KioskId"
                    asp-route-browserFingerprint="@Model.BrowserFingerprint"
                    class="btn btn-success btn-lg w-100 py-5 d-flex flex-column align-items-center justify-content-center"
                    style="font-size: 1.5rem;">
                    <i class="bi bi-box-arrow-right mb-3" style="font-size: 3rem;"></i>
                    <span>Return Books</span>
                </a>
            </div>
            <div class="text-center mb-5 col-md-4">
                @if (!string.IsNullOrEmpty(Model.Library.Logo))
                {
                    <div class="mb-4">
                        <img src="@Model.Library.Logo" alt="@Model.Library.Name Logo" class="img-fluid"
                            style="max-height: 200px; object-fit: contain;" />
                    </div>
                }
                <h1 class="display-4 mb-3">@Model.Library.Name</h1>
                @if (!string.IsNullOrEmpty(Model.Library.Description))
                {
                    <p class="lead text-muted">@Model.Library.Description</p>
                }
                @if (Model.Kiosk != null)
                {
                    <p class="text-muted"><small><i class="bi bi-geo-alt-fill"></i> Kiosk Location:
                            @Model.Kiosk.Location</small></p>
                }
            </div>
            <div class="col-md-4">
                <a asp-page="/Checkout" asp-route-libraryId="@Model.LibraryId" asp-route-kioskId="@Model.KioskId"
                    asp-route-browserFingerprint="@Model.BrowserFingerprint"
                    class="btn btn-primary btn-lg w-100 py-5 d-flex flex-column align-items-center justify-content-center"
                    style="font-size: 1.5rem;">
                    <i class="bi bi-box-arrow-right mb-3" style="font-size: 3rem;"></i>
                    <span>Checkout Books</span>
                </a>
            </div>
        </div>
    </div>
}
else
{
    <div class="container d-flex align-items-center justify-content-center" style="min-height: 80vh;">
        <div class="text-center">
            <div class="mb-4">
                <i class="bi bi-book-fill text-primary" style="font-size: 5rem;"></i>
            </div>
            <h1 class="display-4 mb-3">Laurel Library</h1>
            <p class="lead text-muted mb-4">Modern Library Management System</p>
            <p class="text-muted">
                Welcome to Laurel Library - a comprehensive solution for managing library operations,
                book checkouts, returns, and member management.
            </p>
            <div class="mt-4">
                <p class="text-muted">
                    <small>Please configure your library and kiosk settings to get started.</small>
                </p>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Check if we need to redirect with localStorage parameters
        (function () {
            const urlParams = new URLSearchParams(window.location.search);
            const hasLibraryId = urlParams.has('libraryId');
            const hasKioskId = urlParams.has('kioskId');
            const hasBrowserFingerprint = urlParams.has('browserFingerprint');

            // If all parameters are already in the URL, do nothing
            if (hasLibraryId && hasKioskId && hasBrowserFingerprint) {
                return;
            }

            // Get parameters from localStorage
            const libraryId = localStorage.getItem('libraryId');
            const kioskId = localStorage.getItem('kioskId');
            const browserFingerprint = localStorage.getItem('browserFingerprint');

            // If we have all required parameters in localStorage, redirect
            if (libraryId && kioskId && browserFingerprint) {
                const params = new URLSearchParams();
                params.set('libraryId', libraryId);
                params.set('kioskId', kioskId);
                params.set('browserFingerprint', browserFingerprint);

                // Redirect to the same page with parameters
                window.location.href = `${window.location.pathname}?${params.toString()}`;
            } else {
                // If no parameters available, show error message
                console.warn('Missing library/kiosk information in localStorage');
            }
        })();
    </script>
}