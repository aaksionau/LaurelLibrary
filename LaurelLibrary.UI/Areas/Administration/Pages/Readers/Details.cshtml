@page "{id:int}"
@using LaurelLibrary.UI.Extensions
@model LaurelLibrary.UI.Areas.Administration.Pages.Readers.DetailsModel

@{
    ViewData["Title"] = "Reader Details";
}

<!-- Page Header -->
<div class="d-flex align-items-center justify-content-between mt-3 mb-4">
    <div class="d-flex align-items-center gap-3">
        <a class="btn btn-link p-0 icon-link" asp-page="List" aria-label="Back to list">
            <i class="bi bi-arrow-left fs-3" aria-hidden="true"></i>
        </a>
        <h1 class="mb-0">Reader Details</h1>
    </div>
    @if (Model.Reader != null)
    {
        <div class="d-flex gap-2">
            <a class="btn btn-primary" asp-page="Update" asp-route-id="@Model.Reader.ReaderId">
                <i class="bi bi-pencil me-1"></i>Edit Reader
            </a>
        </div>
    }
</div>

@if (Model.Reader == null)
{
    <div class="alert alert-warning">Reader not found.</div>
}
else
{
    <!-- Main Reader Information Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h2 class="card-title mb-3">@Model.Reader.FullName</h2>
            <div class="mb-3">
                <p class="mb-2">
                    <i class="bi bi-hash text-primary me-2"></i>
                    <strong>Reader ID:</strong>
                    <span class="ms-1">#@Model.Reader.ReaderId</span>
                </p>
                <p class="mb-2">
                    <i class="bi bi-calendar text-primary me-2"></i>
                    <strong>Date of Birth:</strong>
                    <span class="ms-1">@Model.Reader.DateOfBirth.ToString("MMMM dd, yyyy")</span>
                </p>
                @if (!string.IsNullOrWhiteSpace(Model.Reader.Email))
                {
                    <p class="mb-2">
                        <i class="bi bi-envelope text-primary me-2"></i>
                        <strong>Email:</strong>
                        <span class="ms-1">@Model.Reader.Email</span>
                    </p>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Reader.Address) || !string.IsNullOrWhiteSpace(Model.Reader.City) ||
                            !string.IsNullOrWhiteSpace(Model.Reader.State) || !string.IsNullOrWhiteSpace(Model.Reader.Zip))
                {
                    <p class="mb-2">
                        <i class="bi bi-geo-alt text-primary me-2"></i>
                        <strong>Address:</strong>
                        <span class="ms-1">
                            @if (!string.IsNullOrWhiteSpace(Model.Reader.Address))
                            {
                                @Model.Reader.Address
                                @if (!string.IsNullOrWhiteSpace(Model.Reader.City) || !string.IsNullOrWhiteSpace(Model.Reader.State)
                                                    || !string.IsNullOrWhiteSpace(Model.Reader.Zip))
                                {
                                    <br />
                                }
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.Reader.City) || !string.IsNullOrWhiteSpace(Model.Reader.State)
                                                || !string.IsNullOrWhiteSpace(Model.Reader.Zip))
                            {
                                @Model.Reader.City
                                @(!string.IsNullOrWhiteSpace(Model.Reader.City) &&
                                                    (!string.IsNullOrWhiteSpace(Model.Reader.State) || !string.IsNullOrWhiteSpace(Model.Reader.Zip)) ?
                                                    ", " : "")
                                @Model.Reader.State
                                @(!string.IsNullOrWhiteSpace(Model.Reader.State) &&
                                                    !string.IsNullOrWhiteSpace(Model.Reader.Zip) ? " " : "")
                                @Model.Reader.Zip
                            }
                        </span>
                    </p>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Reader.Ean))
                {
                    <p class="mb-2">
                        <i class="bi bi-upc-scan text-primary me-2"></i>
                        <strong>EAN Barcode:</strong>
                        <span class="ms-1 font-monospace">@Model.Reader.Ean</span>
                    </p>
                }
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-3" id="readerDetailsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details-pane"
                type="button" role="tab" aria-controls="details-pane" aria-selected="true">
                <i class="bi bi-info-circle me-2"></i>Details
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="barcode-tab" data-bs-toggle="tab" data-bs-target="#barcode-pane" type="button"
                role="tab" aria-controls="barcode-pane" aria-selected="false">
                <i class="bi bi-upc-scan me-2"></i>Barcode
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-pane" type="button"
                role="tab" aria-controls="history-pane" aria-selected="false">
                <i class="bi bi-book me-2"></i>Borrowing History
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions-pane" type="button"
                role="tab" aria-controls="actions-pane" aria-selected="false">
                <i class="bi bi-journal-text me-2"></i>Reader Actions
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit-pane" type="button"
                role="tab" aria-controls="audit-pane" aria-selected="false">
                <i class="bi bi-clock-history me-2"></i>Audit Information
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="readerDetailsTabContent">
        <!-- Details Tab -->
        <div class="tab-pane fade show active" id="details-pane" role="tabpanel" aria-labelledby="details-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    <!-- Reader Information in organized sections -->
                    <div class="row g-4">
                        <!-- Personal Information -->
                        <div class="col-md-6">
                            <h5 class="text-muted mb-3"><i class="bi bi-person-circle me-2"></i>Personal Information</h5>
                            <div>
                                <div class="mb-2"><strong>First Name:</strong> <span
                                        class="ms-1">@Model.Reader.FirstName</span></div>
                                <div class="mb-2"><strong>Last Name:</strong> <span
                                        class="ms-1">@Model.Reader.LastName</span></div>
                                <div class="mb-2"><strong>Date of Birth:</strong> <span
                                        class="ms-1">@Model.Reader.DateOfBirth.ToString("MMMM dd, yyyy")</span></div>
                                @if (!string.IsNullOrWhiteSpace(Model.Reader.Ean))
                                {
                                    <div class="mb-2"><strong>EAN Barcode:</strong> <span
                                            class="ms-1 font-monospace">@Model.Reader.Ean</span></div>
                                }
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="col-md-6">
                            <h5 class="text-muted mb-3"><i class="bi bi-envelope me-2"></i>Contact Information</h5>
                            <div>
                                @if (!string.IsNullOrWhiteSpace(Model.Reader.Email))
                                {
                                    <div class="mb-2"><strong>Email:</strong> <span class="ms-1">@Model.Reader.Email</span>
                                    </div>
                                }
                                @if (!string.IsNullOrWhiteSpace(Model.Reader.Address) ||
                                                            !string.IsNullOrWhiteSpace(Model.Reader.City) ||
                                                            !string.IsNullOrWhiteSpace(Model.Reader.State) ||
                                                            !string.IsNullOrWhiteSpace(Model.Reader.Zip))
                                {
                                    <div class="mb-2">
                                        <strong>Full Address:</strong>
                                        <span class="ms-1">
                                            @if (!string.IsNullOrWhiteSpace(Model.Reader.Address))
                                            {
                                                @Model.Reader.Address
                                                @if (!string.IsNullOrWhiteSpace(Model.Reader.City) ||
                                                                                    !string.IsNullOrWhiteSpace(Model.Reader.State) ||
                                                                                    !string.IsNullOrWhiteSpace(Model.Reader.Zip))
                                                {
                                                    <br />
                                                }
                                            }
                                            @if (!string.IsNullOrWhiteSpace(Model.Reader.City) ||
                                                                                !string.IsNullOrWhiteSpace(Model.Reader.State) ||
                                                                                !string.IsNullOrWhiteSpace(Model.Reader.Zip))
                                            {
                                                @Model.Reader.City
                                                @(!string.IsNullOrWhiteSpace(Model.Reader.City) &&
                                                                                    (!string.IsNullOrWhiteSpace(Model.Reader.State) ||
                                                                                    !string.IsNullOrWhiteSpace(Model.Reader.Zip)) ? ", " :
                                                                                    "")
                                                @Model.Reader.State
                                                @(!string.IsNullOrWhiteSpace(Model.Reader.State) &&
                                                                                    !string.IsNullOrWhiteSpace(Model.Reader.Zip) ? " " : "")
                                                @Model.Reader.Zip
                                            }
                                        </span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Associated Libraries Section -->
                    <div class="row g-4 mt-3">
                        <div class="col-12">
                            <h5 class="text-muted mb-3"><i class="bi bi-building me-2"></i>Associated Libraries</h5>
                            <div>
                                @if (Model.Reader.LibraryNames.Any())
                                {
                                    <ul class="list-unstyled mb-0">
                                        @foreach (var libraryName in Model.Reader.LibraryNames)
                                        {
                                            <li class="mb-2">
                                                <i class="bi bi-building-check text-success me-2"></i>@libraryName
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <div class="alert alert-warning mb-0">
                                        <i class="bi bi-exclamation-triangle me-2"></i>No libraries associated
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Reader ID (Technical) -->
                    <div class="mt-4 pt-3 border-top">
                        <small class="text-muted"><strong>Reader ID:</strong> <code>@Model.Reader.ReaderId</code></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barcode Tab -->
        <div class="tab-pane fade" id="barcode-pane" role="tabpanel" aria-labelledby="barcode-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6 offset-lg-3 text-center">
                            @if (!string.IsNullOrWhiteSpace(Model.Reader.BarcodeImageUrl))
                            {
                                <div class="mb-3">
                                    <img src="@Html.GetBlobUrl(Model.Reader.BarcodeImageUrl)" alt="Reader Barcode for @Model.Reader.FullName"
                                        class="img-fluid border rounded p-3 bg-white" style="max-width: 100%;"
                                        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                                    <div class="alert alert-warning mt-3" style="display: none;">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Barcode image not available
                                    </div>
                                </div>
                                @if (!string.IsNullOrWhiteSpace(Model.Reader.Ean))
                                {
                                    <p class="text-muted font-monospace fs-5">@Model.Reader.Ean</p>
                                }
                                <div class="d-flex gap-2 justify-content-center mt-4">
                                    <form method="post" asp-page-handler="RegenerateBarcode"
                                        asp-route-id="@Model.Reader.ReaderId"
                                        onsubmit="return confirm('Are you sure you want to regenerate the barcode? This will create a new barcode image.');">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-warning">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Regenerate Barcode
                                        </button>
                                    </form>
                                    <button type="button" class="btn btn-primary" onclick="printBarcode()">
                                        <i class="bi bi-printer me-1"></i>Print Barcode
                                    </button>
                                </div>
                            }
                            else if (!string.IsNullOrWhiteSpace(Model.Reader.Ean))
                            {
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <div>Barcode image not generated</div>
                                    <div class="font-monospace mt-3 fs-5">@Model.Reader.Ean</div>
                                </div>
                                <div class="d-flex gap-2 justify-content-center mt-3">
                                    <form method="post" asp-page-handler="RegenerateBarcode"
                                        asp-route-id="@Model.Reader.ReaderId">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Generate Barcode
                                        </button>
                                    </form>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-secondary mb-0">
                                    <i class="bi bi-dash-circle me-2"></i>No barcode available for this reader
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Borrowing History Tab -->
        <div class="tab-pane fade" id="history-pane" role="tabpanel" aria-labelledby="history-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    @if (Model.BorrowingHistory == null || !Model.BorrowingHistory.Any())
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>No borrowing history found for this reader.
                        </div>
                    }
                    else
                    {
                        <h5 class="mb-3">Borrowing History</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Book Title</th>
                                        <th>Author(s)</th>
                                        <th>ISBN</th>
                                        <th>Checked Out</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.BorrowingHistory)
                                    {
                                        <tr>
                                            <td>
                                                <strong>@item.BookTitle</strong>
                                            </td>
                                            <td>@item.AuthorNames</td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(item.BookIsbn))
                                                {
                                                    <span class="font-monospace">@item.BookIsbn</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">N/A</span>
                                                }
                                            </td>
                                            <td>
                                                @if (item.CheckedOutDate.HasValue)
                                                {
                                                    <span>@item.CheckedOutDate.Value.ToString("MMM dd, yyyy")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">N/A</span>
                                                }
                                            </td>
                                            <td>
                                                @if (item.DueDate.HasValue)
                                                {
                                                    var isOverdue = item.IsCurrentlyBorrowed && item.DueDate.Value < DateTimeOffset.Now;
                                                    <span class="@(isOverdue ? "text-danger fw-bold" : "")">
                                                        @item.DueDate.Value.ToString("MMM dd, yyyy")
                                                        @if (isOverdue)
                                                        {
                                                            <i class="bi bi-exclamation-triangle ms-1" title="Overdue"></i>
                                                        }
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">N/A</span>
                                                }
                                            </td>
                                            <td>
                                                @if (item.IsCurrentlyBorrowed)
                                                {
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="bi bi-book me-1"></i>Currently Borrowed
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-check-circle me-1"></i>Returned
                                                    </span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Showing @Model.BorrowingHistory.Count total record(s)
                            </small>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Reader Actions Tab -->
        <div class="tab-pane fade" id="actions-pane" role="tabpanel" aria-labelledby="actions-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    @if (Model.ReaderActions == null || !Model.ReaderActions.Any())
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>No reader actions found for this reader.
                        </div>
                    }
                    else
                    {
                        <h5 class="mb-3">Reader Actions History</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Action</th>
                                        <th>Book Title</th>
                                        <th>Author(s)</th>
                                        <th>ISBN</th>
                                        <th>Date</th>
                                        <th>Due Date</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var action in Model.ReaderActions)
                                    {
                                        <tr>
                                            <td>
                                                @if (action.ActionType == "CHECKOUT")
                                                {
                                                    <span class="badge bg-primary">
                                                        <i class="bi bi-box-arrow-down me-1"></i>Checkout
                                                    </span>
                                                }
                                                else if (action.ActionType == "RETURN")
                                                {
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-box-arrow-up me-1"></i>Return
                                                    </span>
                                                }
                                            </td>
                                            <td>
                                                <strong>@action.BookTitle</strong>
                                            </td>
                                            <td>@action.BookAuthors</td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(action.BookIsbn))
                                                {
                                                    <span class="font-monospace">@action.BookIsbn</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">N/A</span>
                                                }
                                            </td>
                                            <td>
                                                <span>@action.ActionDate.ToString("MMM dd, yyyy HH:mm")</span>
                                            </td>
                                            <td>
                                                @if (action.DueDate.HasValue)
                                                {
                                                    <span>@action.DueDate.Value.ToString("MMM dd, yyyy")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">N/A</span>
                                                }
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(action.Notes))
                                                {
                                                    <span>@action.Notes</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Showing @Model.ReaderActions.Count recent action(s)
                            </small>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Audit Information Tab -->
        <div class="tab-pane fade" id="audit-pane" role="tabpanel" aria-labelledby="audit-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">Created</h6>
                                <div class="mb-1">
                                    <strong>Date:</strong>
                                    <span class="ms-1">@Model.Reader.CreatedAt.ToString("g")</span>
                                </div>
                                <div>
                                    <strong>By:</strong>
                                    <span class="ms-1">@Model.Reader.CreatedBy</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">Last Updated</h6>
                                <div class="mb-1">
                                    <strong>Date:</strong>
                                    <span class="ms-1">@Model.Reader.UpdatedAt.ToString("g")</span>
                                </div>
                                <div>
                                    <strong>By:</strong>
                                    <span class="ms-1">@Model.Reader.UpdatedBy</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden print area -->
    <div id="printArea" style="display: none;">
        <style>
            @@media print {
                @@page {
                    size: auto;
                    margin: 10mm;
                }

                body {
                    margin: 0;
                }

                .print-container {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 15px;
                }

                .print-barcode-card {
                    page-break-inside: avoid;
                    width: calc(50% - 10px);
                    border: 1px solid #ddd;
                    padding: 15px;
                    text-align: center;
                    box-sizing: border-box;
                }

                .print-barcode-card h4 {
                    margin: 10px 0 5px 0;
                    font-size: 16px;
                }

                .print-barcode-card p {
                    margin: 5px 0;
                    font-size: 12px;
                }

                .print-barcode-card img {
                    max-width: 100%;
                    height: auto;
                }
            }
        </style>
        <div class="print-container">
            @if (!string.IsNullOrEmpty(Model.Reader.BarcodeImageUrl))
            {
                <div class="print-barcode-card">
                    <h4>@Model.Reader.FirstName @Model.Reader.LastName</h4>
                    <p><strong>EAN:</strong> @Model.Reader.Ean</p>
                    <p><strong>Library:</strong> @string.Join(", ", Model.Reader.LibraryNames)</p>
                    <img src="@Model.Reader.BarcodeImageUrl" alt="Barcode for @Model.Reader.FullName" />
                </div>
            }
        </div>
    </div>
}

@section Scripts {
    <script>
        function printBarcode() {
            // Clone the print area
            var printContent = document.getElementById('printArea').innerHTML;

            // Create a new window for printing
            var printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Print Barcode</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('@@page { size: auto; margin: 10mm; }');
            printWindow.document.write('body { margin: 0; font-family: Arial, sans-serif; }');
            printWindow.document.write('.print-container { display: flex; flex-wrap: wrap; gap: 15px; }');
            printWindow.document.write('.print-barcode-card { page-break-inside: avoid; width: calc(50% - 10px); border: 1px solid #ddd; padding: 15px; text-align: center; box-sizing: border-box; }');
            printWindow.document.write('.print-barcode-card h4 { margin: 10px 0 5px 0; font-size: 16px; }');
            printWindow.document.write('.print-barcode-card p { margin: 5px 0; font-size: 12px; }');
            printWindow.document.write('.print-barcode-card img { max-width: 100%; height: auto; }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();

            // Wait for images to load before printing
            printWindow.onload = function () {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };
        }
    </script>
}